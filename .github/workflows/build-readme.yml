name: Build README
on:
  push:
    paths:
      - "Backlog.md"
      - "backlog/**"
      - "docs/**"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build README
        run: |
          # Extract the board section from Backlog.md (skip the header and metadata)
          echo "## ðŸ“Š Backlog.md Project Status (automatically generated by Backlog.md)" > temp_board.md
          echo "" >> temp_board.md

          # Extract generation timestamp from Backlog.md
          TIMESTAMP=$(grep "Generated on:" Backlog.md | sed 's/Generated on: //')
          echo "Generated on: $TIMESTAMP" >> temp_board.md
          echo "" >> temp_board.md

          # Extract the table content (from the table header onwards)
          sed -n '/^| To Do/,$p' Backlog.md >> temp_board.md
          echo "" >> temp_board.md
          echo "_Run \`backlog board export\` to update this section_" >> temp_board.md

          # Create the replacement content with proper escaping
          {
            echo "<!-- BOARD_START -->"
            echo ""
            cat temp_board.md
            echo ""
            echo "<!-- BOARD_END -->"
          } > replacement.md

          # Replace section between markers using awk for better handling
          awk '
            BEGIN { in_section = 0; replacement_printed = 0 }
            /<!-- BOARD_START -->/ { 
              in_section = 1
              if (!replacement_printed) {
                while ((getline line < "replacement.md") > 0) {
                  print line
                }
                close("replacement.md")
                replacement_printed = 1
              }
              next
            }
            /<!-- BOARD_END -->/ { 
              in_section = 0
              next
            }
            !in_section { print }
          ' README.md > README_new.md

          # Replace the original file
          mv README_new.md README.md

          # Cleanup
          rm temp_board.md replacement.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: auto-update README board section from Backlog.md"
            git push
          fi
